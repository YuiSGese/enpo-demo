<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>セールページ作成</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <!-- Thư viện SortableJS để kéo và thả -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <!-- Thư viện PapaParse để đọc file CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
      /* ==========================================================================
   1. Base Styles
   ========================================================================== */

      /*
 * Sets the base font for the entire project and default background/text colors.
 */
      body {
        font-family: "Noto Sans JP", sans-serif;
        background-color: #f3f4f6; /* Equivalent to bg-gray-100 */
        color: #1f2937; /* Equivalent to text-gray-800 */
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* ==========================================================================
   2. Layout & Card Components
   ========================================================================== */

      /*
 * The main container card for settings sections.
 */
      .setting-card {
        background-color: #ffffff;
        border: 1px solid #e5e7eb; /* border-gray-200 */
        border-radius: 0.75rem; /* rounded-xl */
        margin-bottom: 1.5rem; /* mb-6 */
        padding: 1.5rem; /* p-6 */
      }

      /*
 * The title style within a .setting-card.
 */
      .setting-title {
        font-size: 1.125rem; /* text-lg */
        font-weight: 700; /* font-bold */
        color: #3f3a39;
        margin-bottom: 1rem; /* mb-4 */
        border-bottom: 1px solid #e5e7eb; /* border-b */
        padding-bottom: 0.75rem; /* pb-3 */
      }

      /* ==========================================================================
   3. Form Elements
   ========================================================================== */

      /*
 * Base styles for all form inputs, select dropdowns, and textareas.
 */
      input,
      select,
      textarea {
        width: 100%;
        padding: 0.5rem 0.75rem; /* py-2 px-3 */
        border-radius: 0.375rem; /* rounded-md */
        border: 1px solid #d1d5db; /* border-gray-300 */
        font-size: 0.875rem; /* text-sm */
        transition: border-color 0.2s, box-shadow 0.2s;
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: #e6372e;
        box-shadow: 0 0 0 2px rgba(230, 55, 46, 0.2);
      }

      input:disabled {
        background-color: #f3f4f6;
        cursor: not-allowed;
      }

      /*
 * Style for form labels.
 */
      label {
        display: block;
        font-weight: 500; /* font-medium */
        color: #3f3a39;
        margin-bottom: 0.5rem; /* mb-2 */
        font-size: 0.875rem; /* text-sm */
      }

      /* ==========================================================================
   4. Buttons
   ========================================================================== */

      /*
 * Primary button style with a red outline.
 */
      .btn-primary {
        display: inline-block;
        padding: 0.5rem 1.25rem;
        font-size: 0.875rem;
        font-weight: 500;
        border-radius: 0.5rem; /* rounded-lg */
        background-color: white;
        border: 2px solid #e6372e;
        color: #e6372e;
        text-align: center;
        cursor: pointer;
        transition: background-color 0.2s, color 0.2s;
      }

      .btn-primary:hover {
        background-color: #e6372e;
        color: white;
      }

      /* ==========================================================================
   5. Table Styles (Excel-like)
   ========================================================================== */

      /*
 * Container to allow horizontal scrolling for large tables.
 */
      .table-container {
        width: 100%;
        overflow-x: auto;
      }

      /*
 * Base styles for data tables.
 */
      .excel-table {
        width: 100%;
        min-width: 600px; /* Ensures table has a minimum width */
        border-collapse: collapse;
      }

      .excel-table th,
      .excel-table td {
        border: 1px solid #e5e7eb; /* border-gray-200 */
        padding: 0; /* Padding is applied to inputs inside */
        font-size: 0.875rem; /* text-sm */
        text-align: center;
        vertical-align: middle;
      }

      /*
 * Header cells with a sticky position to stay visible on scroll.
 */
      .excel-table th {
        background-color: #f9fafb; /* bg-gray-50 */
        padding: 0.5rem;
        font-weight: 600; /* font-semibold */
        position: sticky;
        top: 0;
        z-index: 10;
      }

      /*
 * Inputs and selects inside table cells are borderless for a seamless look.
 */
      .excel-table td input,
      .excel-table td select {
        border: none;
        border-radius: 0;
        padding: 0.5rem;
        height: 100%;
        width: 100%;
        background-color: transparent;
      }

      .excel-table td .time-input-group input {
        margin-bottom: 4px;
      }
      .excel-table td .time-input-group input:last-child {
        margin-bottom: 0;
      }

      /*
 * Custom focus state for inputs inside the table for better visibility.
 */
      .excel-table td input:focus,
      .excel-table td select:focus {
        outline: 2px solid #e6372e;
        outline-offset: -2px;
        z-index: 1;
        position: relative;
      }

      .coupon-preview {
        height: 80px;
        width: 120px;
        object-fit: contain;
      }

      /* ==========================================================================
   6. Sortable (Drag & Drop) Styles
   ========================================================================== */

      /*
 * Handle used to drag and reorder table rows.
 */
      .drag-handle {
        cursor: grab;
        text-align: center;
        width: 40px;
        color: #9ca3af; /* text-gray-400 */
        background-color: #f9fafb; /* bg-gray-50 */
      }

      .drag-handle:active {
        cursor: grabbing;
      }

      /*
 * Visual feedback for the placeholder row when dragging.
 */
      .sortable-ghost {
        background-color: #fef3c7; /* yellow-100 */
        opacity: 0.7;
      }

      /* ==========================================================================
   7. Miscellaneous Components
   ========================================================================== */

      /*
 * Hides the scrollbar for horizontal scrolling containers (e.g., template selector).
 */
      .template-scroll-container::-webkit-scrollbar {
        display: none;
      }

      .template-scroll-container {
        -ms-overflow-style: none; /* IE and Edge */
        scrollbar-width: none; /* Firefox */
      }
    </style>
  </head>
  <body class="bg-gray-100 text-gray-800">
    <!-- Header -->
    <header
      class="bg-white shadow-md h-20 flex justify-between items-center px-4 sm:px-8 sticky top-0 z-20"
    >
      <h1 class="text-lg sm:text-xl font-bold text-[#3F3A39]">
        セールページ作成
      </h1>
    </header>

    <!-- Main Content: Editor -->
    <main class="p-4 sm:p-6 max-w-7xl mx-auto">
      <!-- 1. Template -->
      <div class="setting-card p-4 md:p-6">
        <h2 class="setting-title">1. テンプレート選択</h2>
        <div class="relative">
          <button
            id="scroll-left"
            class="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-4 bg-white rounded-full p-1 shadow-md z-10 hover:bg-gray-100"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6 text-gray-600"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 19l-7-7 7-7"
              />
            </svg>
          </button>
          <div
            id="template-container"
            class="template-scroll-container flex items-start gap-4 overflow-x-auto scroll-smooth"
          >
            <!-- Templates will be dynamically inserted here -->
            <script>
              const templates = [
                {
                  id: 1,
                  name: "テンプレート1",
                  img: "img/template1.png",
                },
                {
                  id: 2,
                  name: "テンプレート2",
                  img: "img/template2.png",
                },
                {
                  id: 3,
                  name: "テンプレート3",
                  img: "img/template3.png",
                },
                {
                  id: 4,
                  name: "テンプレート4",
                  img: "img/template4.png",
                },
                {
                  id: 5,
                  name: "テンプレート5",
                  img: "https://placehold.co/150x200/d1fae5/047857?text=Template5",
                },
                {
                  id: 6,
                  name: "テンプレート6",
                  img: "https://placehold.co/150x200/d1fae5/047857?text=Template6",
                },
                {
                  id: 7,
                  name: "テンプレート7",
                  img: "https://placehold.co/150x200/d1fae5/047857?text=Template7",
                },
                {
                  id: 8,
                  name: "テンプレート8",
                  img: "https://placehold.co/150x200/d1fae5/047857?text=Template8",
                },
                {
                  id: 9,
                  name: "テンプレート9",
                  img: "https://placehold.co/150x200/d1fae5/047857?text=Template9",
                },
                {
                  id: 10,
                  name: "テンプレート10",
                  img: "https://placehold.co/150x200/d1fae5/047857?text=Template10",
                },
              ];
              const container = document.getElementById("template-container");
              templates.forEach((template, index) => {
                container.innerHTML += `
                        <div class="flex-shrink-0 text-center">
                            <img src="${template.img}" alt="${
                  template.name
                }" class="w-36 h-48 object-cover rounded-lg mb-2 cursor-pointer border-2 border-transparent hover:border-red-400" onclick="openModal('${
                  template.img
                }')">
                            <p class="text-sm font-medium text-gray-700">${
                              template.name
                            }</p>
                            <input type="radio" id="template-${
                              template.id
                            }" name="template-select" value="${
                  template.id
                }" class="mt-1" ${index === 0 ? "checked" : ""}>
                        </div>
                    `;
              });
            </script>
          </div>
          <button
            id="scroll-right"
            class="absolute right-0 top-1/2 -translate-y-1/2 translate-x-4 bg-white rounded-full p-1 shadow-md z-10 hover:bg-gray-100"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6 text-gray-600"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 5l7 7-7 7"
              />
            </svg>
          </button>
        </div>
      </div>

      <!-- 2. Event Info -->
      <div class="setting-card p-4 md:p-6">
        <h2 class="setting-title">2. イベント情報</h2>
        <p class="text-sm text-gray-600 mb-4">
          <span class="text-red-500">*</span> は必須項目です。
        </p>
        <div>
          <label for="event-name"
            >イベント名<span class="text-red-500">*</span></label
          >
          <select id="event-name" onchange="toggleOtherEvent(this)">
            <option>お買い物マラソン</option>
            <option>楽天スーパーSALE</option>
            <option value="other">その他</option>
          </select>
        </div>
        <div id="other-event-wrapper" class="mt-4 hidden">
          <label for="other-event-name"
            >イベント名を入力<span class="text-red-500">*</span></label
          >
          <input
            type="text"
            id="other-event-name"
            placeholder="カスタムイベント名"
          />
        </div>
        <div class="mt-4">
          <label for="store-logo"
            >店舗ロゴ画像URL
            <span class="text-gray-400 font-normal">(任意)</span></label
          >
          <input
            type="url"
            id="store-logo"
            placeholder="https://image.rakuten.co.jp/shop/cabinet/logo.jpg"
          />
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
          <div>
            <label for="sale-start"
              >セール開始日時<span class="text-red-500">*</span></label
            ><input type="datetime-local" id="sale-start" />
          </div>
          <div>
            <label for="sale-end"
              >セール終了日時<span class="text-red-500">*</span></label
            ><input type="datetime-local" id="sale-end" />
          </div>
        </div>
      </div>

      <!-- 3. Coupon Settings -->
      <div class="setting-card p-4 md:p-6">
        <h2 class="setting-title">3. クーポン設定</h2>
        <!-- Common Time Settings -->
        <div class="mb-6 border-b pb-6">
          <p class="font-semibold text-sm mb-3 text-gray-800">
            共通のクーポン期間
          </p>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="coupon-common-start">開始日時（共通）</label>
              <input type="datetime-local" id="coupon-common-start" />
            </div>
            <div>
              <label for="coupon-common-end">終了日時（共通）</label>
              <input type="datetime-local" id="coupon-common-end" />
            </div>
          </div>
          <p class="text-xs text-gray-500 mt-2">
            ここに時間を設定すると、下の各クーポンで「共通設定を使用する」がチェックされているものに適用されます。
          </p>
        </div>

        <!-- Coupon Table -->
        <div class="flex justify-end">
          <div class="mb-4 flex items-center space-x-2">
            <button
              onclick="addCouponRow()"
              class="px-3 py-1.5 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700"
            >
              ＋ クーポン行を追加
            </button>
            <button
              onclick="addMultipleCouponRows(5)"
              class="px-3 py-1.5 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700"
            >
              ＋ 5行追加
            </button>
          </div>
        </div>
        <div class="table-container">
          <table class="excel-table w-full">
            <thead>
              <tr>
                <th class="w-10">#</th>
                <th class="w-32">プレビュー</th>
                <th class="w-auto">クーポン画像URL</th>
                <th class="w-auto">クーポン取得URL</th>
                <th class="w-24 text-center">共通設定</th>
                <th class="w-52">開始 / 終了日時</th>
                <th class="w-20 text-center">削除</th>
              </tr>
            </thead>
            <tbody id="coupon-table-body">
              <!-- Bảng coupon sẽ bắt đầu trống -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- 4. Section Settings -->
      <div id="section-settings-card" class="setting-card p-4 md:p-6">
        <div
          class="flex justify-between items-center mb-4 border-b border-gray-200 pb-3"
        >
          <h2 class="text-lg font-bold text-[#3F3A39]">4. セクション設定</h2>
          <div class="flex items-center space-x-2">
            <button
              onclick="addSectionRow()"
              class="px-3 py-1.5 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700"
            >
              ＋ セクション行を追加
            </button>
            <button
              onclick="addMultipleSectionRows(5)"
              class="px-3 py-1.5 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700"
            >
              ＋ 5行追加
            </button>
          </div>
        </div>
        <p class="text-sm text-gray-600 mb-4">
          セールページ内のナビゲーション（目次）と、各セクションのタイトルを設定します。
        </p>
        <div class="table-container">
          <table class="excel-table w-full">
            <thead>
              <tr>
                <th class="w-10">#</th>
                <th class="w-auto">テキスト（ナビ）</th>
                <th class="w-auto">テキスト（セクション）</th>
                <th class="w-auto">セクションURL（任意）</th>
                <th class="w-20 text-center">削除</th>
              </tr>
            </thead>
            <tbody id="section-table-body">
              <!-- Bảng section sẽ bắt đầu trống -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- 5. Product List -->
      <div class="setting-card p-4 md:p-6">
        <div
          class="flex justify-between items-center mb-4 border-b border-gray-200 pb-3"
        >
          <h2 class="text-lg font-bold text-[#3F3A39]">5. 商品リスト設定</h2>
          <div class="flex flex-wrap items-center gap-2">
            <button
              onclick="addProductRow()"
              class="px-3 py-1.5 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700"
            >
              行を追加
            </button>
            <button
              onclick="addMultipleProductRows(5)"
              class="px-3 py-1.5 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700"
            >
              ＋ 5行追加
            </button>
            <button
              id="csv-upload-btn"
              class="px-3 py-1.5 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300"
            >
              CSVで一括取り込む
            </button>
            <input
              type="file"
              id="csv-file-input"
              class="hidden"
              accept=".csv"
            />
          </div>
        </div>
        <p class="text-sm text-gray-600 mb-4">
          各セクションに表示する商品を登録・編集します。「セクション」は、上記で設定した「テキスト（ナビ）」と連動します。
        </p>

        <div class="table-container">
          <table class="excel-table product-table">
            <thead>
              <tr>
                <th class="w-10">#</th>
                <th class="w-40">セクション</th>
                <th class="w-40">画像サイズ</th>
                <th class="w-48">商品名（表示用）</th>
                <th class="w-48">商品名（SEO用）</th>
                <th class="w-48">商品説明</th>
                <th class="w-40">価格種別</th>
                <th class="w-32">通常価格</th>
                <th class="w-32">SALE価格</th>
                <th class="w-32">割引表示</th>
                <th class="w-48">商品URL</th>
                <th class="w-48">画像URL</th>
                <th class="w-20 text-center">削除</th>
              </tr>
            </thead>
            <tbody id="product-table-body">
              <!-- Bảng sản phẩm sẽ bắt đầu trống -->
            </tbody>
          </table>
        </div>
      </div>
    </main>

    <div class="p-4 sm:p-6 max-w-7xl mx-auto flex justify-end">
      <button id="preview-btn" class="btn-primary">プレビュー</button>
    </div>

    <!-- Modal for Quick View -->
    <div
      id="imageModal"
      class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4"
    >
      <div class="bg-white p-4 rounded-lg shadow-xl relative max-w-lg w-full">
        <button
          onclick="closeModal()"
          class="absolute top-2 right-2 text-gray-500 hover:text-gray-800"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
        <img
          id="modalImage"
          src=""
          alt="Template Preview"
          class="w-full h-auto object-contain max-h-[80vh]"
        />
      </div>
    </div>

    <!-- CSV Upload Notification Modal -->
    <div
      id="csv-notification-modal"
      class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4"
    >
      <div
        class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm text-center"
      >
        <p class="mb-4 text-gray-800">
          CSVからセクションが自動追加されました。「4.
          セクション設定」を確認・編集してください。
        </p>
        <div class="flex justify-center space-x-4">
          <button
            id="goto-section-btn"
            class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700"
          >
            セクション設定へ移動
          </button>
          <button
            id="close-csv-modal-btn"
            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300"
          >
            閉じる
          </button>
        </div>
      </div>
    </div>

    <script>
      // --- General Setup ---
      document.addEventListener("DOMContentLoaded", () => {
        // Khởi tạo các bảng và chức năng kéo thả
        const couponTableBody = document.getElementById("coupon-table-body");
        const sectionTableBody = document.getElementById("section-table-body");
        const productTableBody = document.getElementById("product-table-body");

        initSortable(couponTableBody);
        initSortable(sectionTableBody);
        initSortable(productTableBody);

        // Thêm một dòng cho mỗi bảng khi tải trang
        addCouponRow();
        addSectionRow();
        addProductRow();

        sectionTableBody.addEventListener(
          "input",
          debounce(updateAllSectionDropdowns, 300)
        );
        sectionTableBody.addEventListener("click", (e) => {
          if (e.target.matches(".delete-btn")) {
            setTimeout(() => {
              updateAllSectionDropdowns();
              updateRowNumbers(sectionTableBody);
            }, 0);
          }
        });

        const csvUploadBtn = document.getElementById("csv-upload-btn");
        const csvFileInput = document.getElementById("csv-file-input");
        csvUploadBtn.addEventListener("click", () => csvFileInput.click());
        csvFileInput.addEventListener("change", handleCsvFile);

        const closeCsvModalBtn = document.getElementById("close-csv-modal-btn");
        const gotoSectionBtn = document.getElementById("goto-section-btn");
        const csvNotificationModal = document.getElementById(
          "csv-notification-modal"
        );
        const sectionSettingsCard = document.getElementById(
          "section-settings-card"
        );

        closeCsvModalBtn.addEventListener("click", () => {
          csvNotificationModal.classList.add("hidden");
          csvNotificationModal.classList.remove("flex");
        });
        gotoSectionBtn.addEventListener("click", () => {
          sectionSettingsCard.scrollIntoView({
            behavior: "smooth",
            block: "start",
          });
          csvNotificationModal.classList.add("hidden");
          csvNotificationModal.classList.remove("flex");
        });

        // Nút Preview
        const previewBtn = document.getElementById("preview-btn");
        previewBtn.addEventListener("click", generatePreview);

        // --- Duplicate Buttons Event Listeners ---
        document
          .getElementById("coupon-duplicate-btn")
          .addEventListener("click", duplicateSelectedCouponRow);
        document
          .getElementById("section-duplicate-btn")
          .addEventListener("click", duplicateSelectedSectionRow);
        document
          .getElementById("product-duplicate-btn")
          .addEventListener("click", duplicateSelectedProductRow);

        couponTableBody.addEventListener("change", (e) => {
          if (e.target.classList.contains("row-checkbox"))
            updateCouponDuplicateToolState();
        });
        sectionTableBody.addEventListener("change", (e) => {
          if (e.target.classList.contains("row-checkbox"))
            updateSectionDuplicateToolState();
        });
        productTableBody.addEventListener("change", (e) => {
          if (e.target.classList.contains("row-checkbox"))
            updateProductDuplicateToolState();
        });
      });

      function debounce(func, delay) {
        let timeout;
        return function (...args) {
          const context = this;
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(context, args), delay);
        };
      }

      function toggleOtherEvent(selectElement) {
        const otherEventWrapper = document.getElementById(
          "other-event-wrapper"
        );
        const otherEventInput = document.getElementById("other-event-name");
        if (selectElement.value === "other") {
          otherEventWrapper.classList.remove("hidden");
          otherEventInput.previousElementSibling.innerHTML =
            'イベント名を入力<span class="text-red-500">*</span>';
        } else {
          otherEventWrapper.classList.add("hidden");
          otherEventInput.previousElementSibling.innerHTML = "イベント名を入力";
        }
      }

      // --- Template Selector Logic ---
      const scrollContainer = document.getElementById("template-container");
      const scrollLeftBtn = document.getElementById("scroll-left");
      const scrollRightBtn = document.getElementById("scroll-right");
      const scrollAmount = 200;

      scrollLeftBtn.addEventListener("click", () => {
        scrollContainer.scrollBy({ left: -scrollAmount, behavior: "smooth" });
      });
      scrollRightBtn.addEventListener("click", () => {
        scrollContainer.scrollBy({ left: scrollAmount, behavior: "smooth" });
      });

      // --- Modal Logic ---
      const modal = document.getElementById("imageModal");
      const modalImage = document.getElementById("modalImage");
      function openModal(imgSrc) {
        modalImage.src = imgSrc;
        modal.classList.remove("hidden");
        modal.classList.add("flex");
      }
      function closeModal() {
        modal.classList.add("hidden");
        modal.classList.remove("flex");
        modalImage.src = "";
      }
      modal.addEventListener("click", (e) => {
        if (e.target === modal) closeModal();
      });

      // --- Table Row Logic (Add, Delete, Renumber, Sort) ---

      function updateRowNumbers(tbody) {
        if (!tbody) return;
        const rows = tbody.querySelectorAll("tr");
        rows.forEach((row, index) => {
          const numberCell = row.querySelector(".row-index"); // Sửa lại để nhắm vào span
          if (numberCell) {
            numberCell.textContent = index + 1;
          }
        });
      }

      function initSortable(tbody) {
        if (!tbody) return;
        new Sortable(tbody, {
          animation: 150,
          handle: ".drag-handle",
          ghostClass: "sortable-ghost",
          onEnd: function () {
            updateRowNumbers(tbody);
          },
        });
      }

      function deleteRow(button) {
        const row = button.closest("tr");
        const tbody = row.parentElement;
        row.remove();
        updateRowNumbers(tbody);
        // Cập nhật trạng thái các nút sao chép sau khi xóa
        if (tbody.id === "coupon-table-body") updateCouponDuplicateToolState();
        if (tbody.id === "section-table-body")
          updateSectionDuplicateToolState();
        if (tbody.id === "product-table-body")
          updateProductDuplicateToolState();
      }

      // --- Coupon Logic ---
      let couponIdCounter = 0;

      function updateCouponPreview(inputElement) {
        const row = inputElement.closest("tr");
        const previewImg = row.querySelector(".coupon-preview");
        const placeholder = "https://placehold.co/120x80/f0f0f0/ccc?text=...";
        if (inputElement.value) {
          previewImg.src = inputElement.value;
          previewImg.onerror = () => {
            previewImg.src = placeholder;
          };
        } else {
          previewImg.src = placeholder;
        }
      }

      function addCouponRow(data = {}) {
        const tableBody = document.getElementById("coupon-table-body");
        couponIdCounter++;
        const newRow = tableBody.insertRow();
        newRow.innerHTML = `
            <td class="drag-handle text-center text-gray-500 cursor-grab">
                 <div class="flex justify-center items-center space-x-2 p-2">
                    <input type="checkbox" class="row-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <span class="row-index font-medium text-gray-600"></span>
                </div>
            </td>
            <td><img class="coupon-preview mx-auto" src="${
              data.imageUrl || "https://placehold.co/120x80/f0f0f0/ccc?text=..."
            }" alt="Preview"></td>
            <td><input type="url" placeholder="https://image.rakuten.co.jp/..." value="${
              data.imageUrl || ""
            }" oninput="updateCouponPreview(this)"></td>
            <td><input type="url" placeholder="https://coupon.rakuten.co.jp/..." value="${
              data.couponUrl || ""
            }"></td>
            <td class="text-center">
                <input type="checkbox" id="use-common-${couponIdCounter}" class="h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500" ${
          data.useCommon === false ? "" : "checked"
        } onchange="toggleCouponTime(this, ${couponIdCounter})">
            </td>
            <td>
                <div class="time-input-group p-1">
                    <input type="datetime-local" class="w-full" value="${
                      data.startTime || ""
                    }">
                    <input type="datetime-local" class="w-full" value="${
                      data.endTime || ""
                    }">
                </div>
            </td>
            <td class="text-center">
              <div class="relative group flex items-center justify-center h-full">
                <button type="button" onclick="deleteRow(this)" class="text-gray-400 hover:text-red-600 p-2 rounded-full transition-colors duration-200">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  </svg>
                </button>
                <span class="absolute -top-10 left-1/2 -translate-x-1/2 whitespace-nowrap rounded-md bg-gray-800 px-2 py-1 text-xs font-semibold text-white opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">削除</span>
              </div>
            </td>
        `;
        toggleCouponTime(
          newRow.querySelector(`#use-common-${couponIdCounter}`),
          couponIdCounter
        );
        updateRowNumbers(tableBody);
      }

      function addMultipleCouponRows(count) {
        for (let i = 0; i < count; i++) {
          addCouponRow();
        }
      }

      function toggleCouponTime(checkbox, couponId) {
        const row = checkbox.closest("tr");
        const timeInputs = row.querySelectorAll('input[type="datetime-local"]');

        timeInputs.forEach((input) => {
          input.disabled = checkbox.checked;
        });
      }

      // --- Section Logic ---
      function addSectionRow(data = {}) {
        const tableBody = document.getElementById("section-table-body");
        const newRow = tableBody.insertRow();
        newRow.innerHTML = `
              <td class="drag-handle text-center text-gray-500 cursor-grab">
                   <div class="flex justify-center items-center space-x-2 p-2">
                    <input type="checkbox" class="row-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <span class="row-index font-medium text-gray-600"></span>
                </div>
              </td>
              <td><input type="text" class="section-nav-input" placeholder="例：おすすめギフト" value="${
                data.navText || ""
              }"></td>
              <td><input type="text" placeholder="例：お歳暮の季節に合わせ..." value="${
                data.sectionText || ""
              }"></td>
              <td><input type="url" placeholder="https://example.com/..." value="${
                data.sectionUrl || ""
              }"></td>
              <td class="text-center">
                <div class="relative group flex items-center justify-center h-full">
                  <button type="button" onclick="deleteRow(this)" class="text-gray-400 hover:text-red-600 p-2 rounded-full transition-colors duration-200 delete-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="3 6 5 6 21 6"></polyline>
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                  </button>
                  <span class="absolute -top-10 left-1/2 -translate-x-1/2 whitespace-nowrap rounded-md bg-gray-800 px-2 py-1 text-xs font-semibold text-white opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">削除</span>
                </div>
              </td>
          `;
        updateRowNumbers(tableBody);
      }

      function addMultipleSectionRows(count) {
        for (let i = 0; i < count; i++) {
          addSectionRow();
        }
      }

      // --- Product Logic ---
      function addProductRow(data = {}) {
        const tableBody = document.getElementById("product-table-body");
        const newRow = tableBody.insertRow();
        newRow.innerHTML = `
              <td class="drag-handle text-center text-gray-500 cursor-grab">
                   <div class="flex justify-center items-center space-x-2 p-2">
                    <input type="checkbox" class="row-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                    <span class="row-index font-medium text-gray-600"></span>
                </div>
              </td>
              <td><select class="section-dropdown"></select></td>
              <td>
                <select>
                  <option value="大" ${
                    data.imageSize === "大" ? "selected" : ""
                  }>大</option>
                  <option value="小" ${
                    data.imageSize === "小" ? "selected" : ""
                  }>小</option>
                </select>
              </td>
              <td><input type="text" value="${
                data.displayName || ""
              }" oninput="this.title=this.value" title="${
          data.displayName || ""
        }" /></td>
              <td><input type="text" value="${
                data.seoName || ""
              }" oninput="this.title=this.value" title="${
          data.seoName || ""
        }" /></td>
              <td><input type="text" value="${
                data.description || ""
              }" oninput="this.title=this.value" title="${
          data.description || ""
        }" /></td>
              <td>
                <select>
                    <option value="当店通常価格" ${
                      data.priceType === "当店通常価格" ? "selected" : ""
                    }>当店通常価格</option>
                    <option value="メーカー希望小売価格" ${
                      data.priceType === "メーカー希望小売価格"
                        ? "selected"
                        : ""
                    }>メーカー希望小売価格</option>
                    <option value="クーポン利用" ${
                      data.priceType === "クーポン利用" ? "selected" : ""
                    }>クーポン利用</option>
                </select>
              </td>
              <td><input type="number" value="${
                data.regularPrice || ""
              }" /></td>
              <td><input type="number" value="${data.salePrice || ""}" /></td>
              <td>
                <select>
                    <option value="%OFF" ${
                      data.discountType === "%OFF" ? "selected" : ""
                    }>%OFF</option>
                    <option value="円OFF" ${
                      data.discountType === "円OFF" ? "selected" : ""
                    }>円OFF</option>
                </select>
              </td>
              <td><input type="url" value="${
                data.productUrl || ""
              }" oninput="this.title=this.value" title="${
          data.productUrl || ""
        }" /></td>
              <td><input type="url" value="${
                data.imageUrl || ""
              }" oninput="this.title=this.value" title="${
          data.imageUrl || ""
        }" /></td>
              <td class="text-center">
                <div class="relative group flex items-center justify-center h-full">
                  <button type="button" onclick="deleteRow(this)" class="text-gray-400 hover:text-red-600 p-2 rounded-full transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="3 6 5 6 21 6"></polyline>
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                  </button>
                  <span class="absolute -top-10 left-1/2 -translate-x-1/2 whitespace-nowrap rounded-md bg-gray-800 px-2 py-1 text-xs font-semibold text-white opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">削除</span>
                </div>
              </td>
          `;
        const dropdown = newRow.querySelector(".section-dropdown");
        updateSectionDropdown(dropdown);
        if (data["セクション"]) dropdown.value = data["セクション"];
        updateRowNumbers(tableBody);
      }

      function addMultipleProductRows(count) {
        for (let i = 0; i < count; i++) {
          addProductRow();
        }
      }

      // --- Duplicate Row Logic ---
      function getDuplicateLogic(tbodyId, addRowFn) {
        const tbody = document.getElementById(tbodyId);
        const countInput = document.getElementById(
          tbodyId.replace("-table-body", "-duplicate-count")
        );
        const duplicateBtn = document.getElementById(
          tbodyId.replace("-table-body", "-duplicate-btn")
        );

        const updateToolState = () => {
          const checked =
            tbody.querySelectorAll(".row-checkbox:checked").length > 0;
          countInput.disabled = !checked;
          duplicateBtn.disabled = !checked;
        };

        const duplicateSelectedRows = () => {
          const checkedBox = tbody.querySelector(".row-checkbox:checked");
          if (!checkedBox) return;

          const rowToCopy = checkedBox.closest("tr");
          const count = parseInt(countInput.value, 10) || 1;
          const data = {};

          if (tbodyId === "coupon-table-body") {
            const cells = rowToCopy.cells;
            data.imageUrl = cells[2].querySelector("input").value;
            data.couponUrl = cells[3].querySelector("input").value;
            const commonCheckbox = cells[4].querySelector("input");
            data.useCommon = commonCheckbox.checked;
            if (!data.useCommon) {
              const timeInputs = cells[5].querySelectorAll("input");
              data.startTime = timeInputs[0].value;
              data.endTime = timeInputs[1].value;
            }
          } else if (tbodyId === "section-table-body") {
            const cells = rowToCopy.cells;
            data.navText = cells[1].querySelector("input").value;
            data.sectionText = cells[2].querySelector("input").value;
            data.sectionUrl = cells[3].querySelector("input").value;
          } else if (tbodyId === "product-table-body") {
            const cells = rowToCopy.cells;
            data.displaySection = cells[1].querySelector("select").value;
            data.imageSize = cells[2].querySelector("select").value;
            data.displayName = cells[3].querySelector("input").value;
            data.seoName = cells[4].querySelector("input").value;
            data.description = cells[5].querySelector("input").value;
            data.priceType = cells[6].querySelector("select").value;
            data.regularPrice = cells[7].querySelector("input").value;
            data.salePrice = cells[8].querySelector("input").value;
            data.discountType = cells[9].querySelector("select").value;
            data.productUrl = cells[10].querySelector("input").value;
            data.imageUrl = cells[11].querySelector("input").value;
          }

          for (let i = 0; i < count; i++) {
            addRowFn(data);
          }
        };

        return { updateToolState, duplicateSelectedRows };
      }

      const {
        updateToolState: updateCouponDuplicateToolState,
        duplicateSelectedRows: duplicateSelectedCouponRow,
      } = getDuplicateLogic("coupon-table-body", addCouponRow);
      const {
        updateToolState: updateSectionDuplicateToolState,
        duplicateSelectedRows: duplicateSelectedSectionRow,
      } = getDuplicateLogic("section-table-body", addSectionRow);
      const {
        updateToolState: updateProductDuplicateToolState,
        duplicateSelectedRows: duplicateSelectedProductRow,
      } = getDuplicateLogic("product-table-body", addProductRow);

      // --- CSV Import Logic ---
      function handleCsvFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        Papa.parse(file, {
          header: true,
          skipEmptyLines: true,
          complete: function (results) {
            const csvSections = [
              ...new Set(
                results.data
                  .map((item) => item["セクション"]?.trim())
                  .filter(Boolean)
              ),
            ];
            const existingSections = Array.from(
              document.querySelectorAll(
                "#section-table-body .section-nav-input"
              )
            ).map((input) => input.value);

            let newSectionsAdded = false;
            csvSections.forEach((csvSectionName) => {
              if (!existingSections.includes(csvSectionName)) {
                addSectionRow({
                  navText: csvSectionName,
                  sectionText: csvSectionName,
                });
                newSectionsAdded = true;
              }
            });

            const productTableBody =
              document.getElementById("product-table-body");
            productTableBody.innerHTML = "";
            results.data.forEach((productData) => {
              addProductRow(productData);
            });

            if (newSectionsAdded) {
              document
                .getElementById("csv-notification-modal")
                .classList.add("flex");
              document
                .getElementById("csv-notification-modal")
                .classList.remove("hidden");
            }
          },
        });
        event.target.value = null;
      }

      // --- Sync Sections and Products ---
      function updateAllSectionDropdowns() {
        const options = Array.from(
          document.querySelectorAll("#section-table-body .section-nav-input")
        )
          .map((input) =>
            input.value
              ? `<option value="${input.value}">${input.value}</option>`
              : ""
          )
          .join("");
        document
          .querySelectorAll("#product-table-body .section-dropdown")
          .forEach((select) => {
            const selectedValue = select.value;
            select.innerHTML = options;
            if (
              [...select.options].map((o) => o.value).includes(selectedValue)
            ) {
              select.value = selectedValue;
            }
          });
      }

      function updateSectionDropdown(selectElement) {
        const options = Array.from(
          document.querySelectorAll("#section-table-body .section-nav-input")
        )
          .map((input) =>
            input.value
              ? `<option value="${input.value}">${input.value}</option>`
              : ""
          )
          .join("");
        selectElement.innerHTML = options;
      }

      // --- Preview Generation Logic ---
      function generatePreview() {
        const eventNameSelect = document.getElementById("event-name");
        let eventName = eventNameSelect.value;
        if (eventName === "other") {
          eventName = document.getElementById("other-event-name").value;
        }

        const data = {
          eventInfo: {
            name: eventName,
            logo: document.getElementById("store-logo").value,
            start: document.getElementById("sale-start").value,
            end: document.getElementById("sale-end").value,
          },
          coupons: [],
          sections: [],
          products: [],
        };

        // Collect Coupons
        document.querySelectorAll("#coupon-table-body tr").forEach((row) => {
          const cells = row.cells;
          const useCommonCheckbox = cells[4].querySelector(
            'input[type="checkbox"]'
          );
          let startTime, endTime;

          if (!useCommonCheckbox.checked) {
            const timeInputs = cells[5].querySelectorAll(
              'input[type="datetime-local"]'
            );
            startTime = timeInputs[0].value;
            endTime = timeInputs[1].value;
          }

          data.coupons.push({
            imageUrl: cells[2].querySelector("input").value,
            couponUrl: cells[3].querySelector("input").value,
            useCommon: useCommonCheckbox.checked,
            startTime: startTime,
            endTime: endTime,
          });
        });

        // Collect Sections
        document.querySelectorAll("#section-table-body tr").forEach((row) => {
          const inputs = row.querySelectorAll("input");
          data.sections.push({
            navText: inputs[1].value,
            sectionText: inputs[2].value,
            sectionUrl: inputs[3].value,
          });
        });

        // Collect Products
        document.querySelectorAll("#product-table-body tr").forEach((row) => {
          const inputs = row.querySelectorAll("input, select");
          data.products.push({
            displaySection: inputs[1].value,
            imageSize: inputs[2].value,
            displayName: inputs[3].value,
            seoName: inputs[4].value,
            description: inputs[5].value,
            priceType: inputs[6].value,
            regularPrice: inputs[7].value,
            salePrice: inputs[8].value,
            discountType: inputs[9].value,
            productUrl: inputs[10].value,
            imageUrl: inputs[11].value,
          });
        });

        localStorage.setItem("salePageData", JSON.stringify(data));
        window.open("salePagePreview.html", "_blank");
      }
    </script>
  </body>
</html>
