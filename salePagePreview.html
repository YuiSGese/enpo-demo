<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>セールページプレビュー</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap"
      rel="stylesheet"
    />
    <style>
      /* ==========================================================================
   1. Base Styles
   ========================================================================== */
      body {
        font-family: "Noto Sans JP", sans-serif;
        background-color: #f3f4f6;
        color: #1f2937;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* ==========================================================================
   2. Preview Page Specific Styles
   ========================================================================== */

      .sale-banner-bg {
        background-color: #d52126;
      }
      .date-box-bg {
        background-color: #b71c1f;
      }
      .sale-title-main {
        font-family: "Noto Sans JP", sans-serif;
        font-weight: 900; /* Black */
        color: white;
        line-height: 1.2;
      }
      .sale-title-sub {
        font-family: "Noto Sans JP", sans-serif;
        font-weight: 900; /* Black */
        color: white;
        line-height: 1;
      }
      .section-title-bg {
        background-color: #333; /* Màu nền ví dụ cho tiêu đề section */
      }
    </style>
  </head>
  <body class="bg-white">
    <!-- Header -->
    <header
      class="bg-white shadow-md h-20 flex justify-between items-center px-4 sm:px-8 sticky top-0 z-20"
    >
      <h1 class="text-lg sm:text-xl font-bold text-[#3F3A39]">
        セールページプレビュー
      </h1>
    </header>

    <!-- Main Preview Content -->
    <main id="preview-main" class="max-w-4xl mx-auto">
      <!-- Nội dung sẽ được tạo động ở đây -->
    </main>

    <!-- Action Buttons Footer -->
    <footer
      class="p-4 sm:p-6 max-w-4xl mx-auto flex justify-end items-center space-x-4"
    >
      <button
        onclick="goBackToEditor()"
        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300"
      >
        修正する
      </button>
      <button
        class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700"
      >
        公開する
      </button>
    </footer>

    <script>
      function goBackToEditor() {
        // This will close the preview tab.
        window.close();
      }

      document.addEventListener("DOMContentLoaded", () => {
        const dataString = localStorage.getItem("salePageData");
        const mainContainer = document.getElementById("preview-main");

        if (!dataString) {
          mainContainer.innerHTML = `<div class="p-8 text-center text-red-500">プレビューデータを読み込めませんでした。作成ページからプレビューを生成してください。</div>`;
          return;
        }

        const data = JSON.parse(dataString);
        mainContainer.innerHTML = ""; // Xóa nội dung giả

        // Render Banner
        const bannerHtml = `
                <div class="sale-banner-bg text-center py-10 px-4">
                    ${
                      data.eventInfo.logo
                        ? `<img src="${data.eventInfo.logo}" alt="店舗ロゴ" class="mx-auto h-12 mb-4 object-contain">`
                        : ``
                    }
                    <h2 class="sale-title-main text-5xl md:text-6xl tracking-wide">${data.eventInfo.name.replace(
                      "SALE",
                      ""
                    )}</h2>
                    <h1 class="sale-title-sub text-7xl md:text-8xl tracking-wider -mt-2">SALE</h1>
                    <div class="inline-block date-box-bg text-white px-6 py-2 rounded-md mt-6 text-base">
                        ${formatDate(data.eventInfo.start)} - ${formatDate(
          data.eventInfo.end
        )}
                    </div>
                </div>
            `;
        mainContainer.insertAdjacentHTML("beforeend", bannerHtml);

        // Render Coupons
        if (
          data.coupons &&
          data.coupons.length > 0 &&
          data.coupons.some((c) => c.imageUrl)
        ) {
          let couponsHtml = `
                    <div class="bg-white py-8 px-4">
                        <div class="max-w-2xl mx-auto space-y-4">
                            <div class="bg-yellow-400 text-center py-2 text-black font-bold">お得なクーポン配布中！</div>
                `;
          data.coupons.forEach((coupon) => {
            if (coupon.imageUrl) {
              couponsHtml += `<a href="${
                coupon.couponUrl || "#"
              }" target="_blank"><img src="${
                coupon.imageUrl
              }" alt="Coupon" class="w-full rounded-lg shadow"></a>`;
            }
          });
          couponsHtml += `</div></div>`;
          mainContainer.insertAdjacentHTML("beforeend", couponsHtml);
        }

        // Render Navigation
        if (
          data.sections &&
          data.sections.length > 0 &&
          data.sections.some((s) => s.navText)
        ) {
          let navHtml = `
                    <div class="bg-white py-8 px-4">
                        <div class="max-w-md mx-auto p-4 border-4 border-yellow-400 rounded-lg">
                            <h3 class="text-center font-bold text-xl mb-4">お買い得商品を探す</h3>
                            <div class="space-y-3">
                 `;
          data.sections.forEach((section) => {
            if (section.navText) {
              const sectionId =
                "section-" + section.navText.replace(/\s+/g, "-").toLowerCase();
              navHtml += `<a href="#${sectionId}" class="block bg-yellow-400 text-black text-center font-bold py-3 rounded-md hover:bg-yellow-500 transition-colors">${section.navText}</a>`;
            }
          });
          navHtml += `</div></div></div>`;
          mainContainer.insertAdjacentHTML("beforeend", navHtml);
        }

        // Render Product Sections
        if (data.sections && data.sections.length > 0) {
          data.sections.forEach((section) => {
            if (section.navText) {
              const sectionId =
                "section-" + section.navText.replace(/\s+/g, "-").toLowerCase();
              const productsInSection = data.products.filter(
                (p) => p.displaySection === section.navText
              );

              if (productsInSection.length > 0) {
                let sectionHtml = `
                            <section id="${sectionId}" class="py-8">
                                <div class="section-title-bg text-center py-4">
                                    <h3 class="text-2xl font-bold text-white">${
                                      section.sectionText || section.navText
                                    }</h3>
                                </div>
                                <div class="bg-white p-4">
                        `;

                const largeProducts = productsInSection.filter(
                  (p) => p.imageSize === "大"
                );
                const smallProducts = productsInSection.filter(
                  (p) => p.imageSize === "小"
                );

                if (largeProducts.length > 0) {
                  const largeProductCards = largeProducts
                    .map((p) => createLargeProductCard(p))
                    .join("");
                  sectionHtml += `<div class="space-y-4">${largeProductCards}</div>`;
                }

                if (smallProducts.length > 0) {
                  const smallProductCards = smallProducts
                    .map((p) => createSmallProductCard(p))
                    .join("");
                  sectionHtml += `<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 ${
                    largeProducts.length > 0 ? "mt-4" : ""
                  }">${smallProductCards}</div>`;
                }

                sectionHtml += `</div></section>`;
                mainContainer.insertAdjacentHTML("beforeend", sectionHtml);
              }
            }
          });
        }
      });

      function createLargeProductCard(product) {
        const regularPrice = parseFloat(product.regularPrice);
        const salePrice = parseFloat(product.salePrice);
        let discountHtml = "";

        if (
          !isNaN(regularPrice) &&
          !isNaN(salePrice) &&
          regularPrice > salePrice
        ) {
          let discountText = "";
          if (product.discountType === "円OFF") {
            const yenOff = (regularPrice - salePrice).toLocaleString();
            discountText = `${yenOff}円OFF`;
          } else {
            // Default to %OFF
            const percentOff = Math.round(
              ((regularPrice - salePrice) / regularPrice) * 100
            );
            discountText = `${percentOff}%OFF`;
          }

          discountHtml = `<p class="text-sm text-gray-500">${
            product.priceType || "当店通常価格"
          } ${regularPrice.toLocaleString()}円のところ <span class="font-bold text-red-500">${discountText}</span></p>`;
        }

        return `
                <a href="${
                  product.productUrl || "#"
                }" target="_blank" class="flex flex-col md:flex-row items-center bg-gray-50 p-4 rounded-lg shadow-sm border hover:shadow-md transition-shadow">
                    <img src="${
                      product.imageUrl ||
                      "https://placehold.co/300x300/cccccc/ffffff?text=No+Image"
                    }" alt="${
          product.displayName
        }" class="w-full md:w-1/3 rounded-lg mb-4 md:mb-0 md:mr-6">
                    <div class="text-left flex-1">
                        <h4 class="text-xl font-bold mb-2">${
                          product.displayName
                        }</h4>
                        <p class="text-gray-600 mb-4">${product.description}</p>
                        ${discountHtml}
                        <p class="text-red-600 font-bold text-3xl">${Number(
                          product.salePrice
                        ).toLocaleString()}<span class="text-lg">円</span><span class="text-sm">(税込)</span></p>
                    </div>
                </a>
            `;
      }

      function createSmallProductCard(product) {
        return `
                <a href="${
                  product.productUrl || "#"
                }" target="_blank" class="text-center bg-gray-50 p-4 rounded-lg shadow-sm border hover:shadow-md transition-shadow">
                    <img src="${
                      product.imageUrl ||
                      "https://placehold.co/300x300/cccccc/ffffff?text=No+Image"
                    }" alt="${
          product.displayName
        }" class="w-full rounded-lg mb-4">
                    <h4 class="font-bold mb-2 h-12 overflow-hidden">${
                      product.displayName
                    }</h4>
                    <p class="text-red-600 font-bold text-2xl">${Number(
                      product.salePrice
                    ).toLocaleString()}<span class="text-sm">円(税込)</span></p>
                </a>
            `;
      }

      function formatDate(dateString) {
        if (!dateString) return "";
        const date = new Date(dateString);
        const month = date.getMonth() + 1;
        const day = date.getDate();
        const hours = String(date.getHours()).padStart(2, "0");
        const minutes = String(date.getMinutes()).padStart(2, "0");
        return `${month}/${day} ${hours}:${minutes}`;
      }
    </script>
  </body>
</html>
